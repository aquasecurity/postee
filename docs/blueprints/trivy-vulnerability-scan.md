# Trivy Vulnerability Scan

## Introduction
In this walkthrough, we will setup vulnerability scanning with [Trivy](https://github.com/aquasecurity/trivy) and send the results to Postee for creation of JIRA tickets as an example.

A video format of this guide is also available [here](https://youtu.be/HZ5Z8jAVH8w?t=420).

## Scenario
A DevOps team would like to configure alerts for scheduled vulnerability scans to be notify them about any vulnerable images that they might be running in their clusters. For this they decide to install Trivy, run it on a schedule and send the results to Postee.

They decide to configure Postee so that upon receiving such alerts, Postee creates a JIRA ticket for them to take a look at it at their disposal.

![img.png](../img/trivy-postee.png)

## Sample Configs
In this case a sample configuration for the components can be described as follows:

### Postee Config

Postee Actions dispatches calls via the HTTP Action to 3 different AWS Lambda URLs. These requests are performed in parallel. In addition, the operator is performed of the trigger and notified via a Slack message.

```yaml
routes:
- name: trivy-alpine-vulns
  input: contains(input.Metadata.OS.Family, "alpine")
  actions: [my-jira]
  template: trivy-raw-json

# Templates are used to format a message
templates:
- name: trivy-raw-json
  rego-package: postee.rawmessage.json

# Actions are target services that should consume the messages
actions:
- name: my-jira
  type: jira
  enable: true
  url: "https://foo.bar.com"
  user: "jdoe@foo.bar.com"
  password: "hunter2"
  project-key:   "ABC"
  board:     "Backlog"
  labels:    ["trivy-vulns"]
```

### Trivy Webhook Plugin Config
A simple bash script can be created in order to send results from Trivy to Postee. The script can then be loaded as a Trivy Plugin as documented [here](https://aquasecurity.github.io/trivy/v0.29.1/docs/advanced/plugins/).

```shell
#!/bin/bash

# Usage
function usage() {
  cat << EOS >&2
Usage: trivy webhook [-h,--help] TYPE NAME [TRIVY OPTION]
 A Trivy plugin that trivy reports to a webhook.

Options:
  -h, --help    Show usage.

Examples:
  trivy webhook <trivy args...>
EOS
  exit
}

function scan {
  trivy --quiet image --format=json $@
}

if [[ ($# -eq 0) || ($1 == "--help") || ($1 == "-h") ]]; then
  # No commands or the --help flag passed and we'll show the usage instructions
  usage
fi

webhook_PARAM=()
for opt in "$@"; do
  case "${opt}" in
    '--' )
      shift
      TRIVY_PARAM=( "$@" )
      break
      ;;
    * )
      if [ -n "$1" ]; then
        webhook_PARAM+=("$1")
      fi
      shift
      ;;
  esac
done

RESULTS="$(scan "$@")"
echo $RESULTS
curl -s -H 'Content-Type: application/json' -d "$RESULTS" localhost:8082
```